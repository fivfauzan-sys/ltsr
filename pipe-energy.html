<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pipe Energy Calculator PRO v7.35</title>
    <style>
        :root { 
            --navy: #0f172a; --gold: #f59e0b; --gold-dark: #d97706;
            --white: #ffffff; --bg: #f1f5f9; --success: #10b981; --danger: #ef4444;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }

        /* HEADER */
        #top-header {
            position: fixed; top: 0; left: 0; right: 0; height: 80px;
            background: var(--navy); color: white; display: flex; align-items: center;
            justify-content: space-between; padding: 0 25px; border-bottom: 5px solid var(--gold); z-index: 1000;
        }
        .header-left { display: flex; flex-direction: column; }
        .main-title { font-weight: 900; font-size: 1.5rem; text-transform: uppercase; }
        .sub-title { font-size: 0.9rem; color: var(--gold); font-weight: 600; }
        
        .credit-tag { 
            background: rgba(245, 158, 11, 0.15); 
            border: 1.5px solid var(--gold); 
            color: var(--gold); 
            padding: 6px 18px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 900; 
            letter-spacing: 0.5px;
        }

        /* SIDEBAR */
        #sidebar { width: 450px; background: var(--white); margin-top: 85px; border-right: 1px solid #cbd5e1; overflow-y: auto; padding: 25px; }
        
        /* GAYA JUDUL BARU (SESUAI GAMBAR REFERENSI) */
        h3 { 
            font-size: 1.1rem; 
            color: var(--gold-dark); 
            border-left: 5px solid var(--gold); 
            padding-left: 12px; 
            margin: 30px 0 15px 0; 
            text-transform: uppercase;
            font-weight: 900;
            line-height: 1.2;
        }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-top: 4px solid var(--navy); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .seg-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #e2e8f0; }
        
        .badge-l { background: var(--navy); color: var(--gold); padding: 5px 10px; border-radius: 6px; font-weight: 900; font-size: 0.9rem; border: 1px solid var(--gold); }
        .badge-c { background: #e2e8f0; color: var(--navy); padding: 5px 10px; border-radius: 6px; font-weight: 900; font-size: 0.8rem; border: 1px solid var(--navy); }

        label { display: block; font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; margin-bottom: 10px; }

        .fitting-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .fitting-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--gold); background: #f8fafc; color: var(--navy); }
        .fitting-table td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; }
        .fitting-table input { width: 45px; padding: 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; }

        #main { flex-grow: 1; margin-top: 85px; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        #canvas-wrapper { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); position: relative;}
        canvas { width: 100%; height: 420px; }

        table.results { width: 100%; border-collapse: collapse; background: white; font-size: 0.85rem; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
        table.results th { background: var(--navy); color: white; padding: 15px; text-transform: uppercase; font-size: 0.75rem; }
        table.results td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .row-special { background: #fffbeb; font-weight: bold; }

        .status-box { flex: 1; padding: 25px; border-radius: 12px; text-align: center; color: white; font-weight: 900; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="top-header">
    <div class="header-left">
        <div class="main-title">Pipe Energy Calculator</div>
        <div class="sub-title">Seksi Perencanaan Sudin Sumber Daya Air Kota Jakarta Selatan</div>
    </div>
    <div class="credit-tag">AsproXSudinJS</div>
</div>

<div id="sidebar">
    <h3>Parameter Sistem</h3>
    <select id="calc_method" onchange="runSimulation(); renderSegmentsUI();">
        <option value="HW">Metode Hazen-Williams (C)</option>
        <option value="DW">Metode Darcy-Weisbach (ε)</option>
    </select>

    <div class="card">
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>El. Dasar Res (m)</label><input type="number" id="el_dasar" value="28.088"></div>
            <div style="flex:1"><label>El. As Pompa (m)</label><input type="number" id="el_pmp" value="29.300"></div>
        </div>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>Tinggi Air (m)</label><input type="number" id="t_air" value="1.442"></div>
            <div style="flex:1"><label>Debit Aliran (m³/s)</label><input type="number" id="debit" value="0.25" step="0.01"></div>
        </div>
        <label>Head Pompa (m)</label><input type="number" id="head_pmp" value="20">
    </div>

    <h3>Konfigurasi Jaringan Pipa</h3>
    <div id="segments-list"></div>
    <button onclick="addSegment()" style="width:100%; background:none; border: 2px dashed var(--gold); color: var(--gold-dark); padding: 12px; cursor: pointer; border-radius: 8px; font-weight: 800; margin-bottom: 25px;">+ TAMBAH SEGMEN PIPA</button>

    <h3>Aksesoris & Fitting (ΣK)</h3>
    <div class="card">
        <table class="fitting-table">
            <thead><tr><th>Aksesoris</th><th>K</th><th>Jumlah</th></tr></thead>
            <tbody id="fitting-body"></tbody>
        </table>
        <div style="margin-top:15px; border-top: 2px solid var(--gold); padding-top:12px; display:flex; justify-content:space-between; font-weight:900; font-size: 1.1rem; color: var(--navy);">
            <span>TOTAL ΣK:</span><span id="total-k-val">0.00</span>
        </div>
    </div>
    <button onclick="runSimulation()" style="width:100%; background:var(--navy); color:var(--gold); border:2px solid var(--gold); padding:20px; border-radius:8px; font-weight:900; cursor:pointer; text-transform:uppercase; letter-spacing:1px; margin-bottom:40px;">Hitung Energi</button>
</div>

<div id="main">
    <div id="canvas-wrapper"><canvas id="pCanvas"></canvas></div>

    <table class="results">
        <thead>
            <tr>
                <th>Objek Jalur</th><th>Koef. Pipa</th><th>L (m)</th><th>V (m/s)</th>
                <th>f (Darcy)</th><th>H-Major (m)</th><th>Elev. HGL (m)</th><th style="background:var(--gold); color:var(--navy)">Head Sisa (m)</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <div class="status-container" style="display:flex; gap:15px">
        <div id="status-kecepatan" class="status-box">STATUS KECEPATAN: -</div>
        <div id="status-head" class="status-box">STATUS HEAD SISA: -</div>
    </div>
</div>

<script>
    const materialsData = [
        { label: "HDPE / PVC", c: 150, eps: 0.0000015 },
        { label: "Baja / Steel", c: 100, eps: 0.000045 },
        { label: "Ductile Iron (DI)", c: 120, eps: 0.00025 },
        { label: "GI (Galvanis)", c: 100, eps: 0.0005 }
    ];

    let segments = [
        { x: 40, y: 35.0, d: 0.3, matIdx: 0 },
        { x: 100, y: 35.0, d: 0.3, matIdx: 0 },
        { x: 180, y: 45.0, d: 0.3, matIdx: 0 }
    ];

    let fittingData = [
        { name: 'Bellmouth Entrance', k: 0.05, qty: 0 },
        { name: 'Foot Valve + Strainer', k: 2.50, qty: 0 },
        { name: 'Screen / Trashrack', k: 0.10, qty: 0 },
        { name: 'Flange Connection', k: 0.08, qty: 0 },
        { name: 'Gate Valve (Open)', k: 0.15, qty: 0 },
        { name: 'Butterfly Valve', k: 0.30, qty: 0 },
        { name: 'Check Valve (Swing)', k: 2.00, qty: 0 },
        { name: 'Elbow 90° (Standard)', k: 0.90, qty: 0 },
        { name: 'Elbow 45° (Standard)', k: 0.40, qty: 0 },
        { name: 'Tee Flow (Straight)', k: 0.60, qty: 0 },
        { name: 'Reducer / Expander', k: 0.25, qty: 0 },
        { name: 'Flexible Joint', k: 0.20, qty: 0 },
        { name: 'Pipe Exit (Outlet)', k: 1.00, qty: 0 }
    ];

    function renderFitting() {
        let totalK = 0;
        document.getElementById('fitting-body').innerHTML = fittingData.map((f, i) => {
            totalK += f.k * f.qty;
            return `<tr><td>${f.name}</td>
                <td><input type="number" step="0.01" value="${f.k}" onchange="fittingData[${i}].k=parseFloat(this.value); runSimulation();"></td>
                <td><input type="number" value="${f.qty}" onchange="fittingData[${i}].qty=parseInt(this.value); runSimulation();"></td></tr>`;
        }).join('');
        document.getElementById('total-k-val').innerText = totalK.toFixed(2);
        return totalK;
    }

    function renderSegmentsUI() {
        const method = document.getElementById('calc_method').value;
        const list = document.getElementById('segments-list');
        list.innerHTML = segments.map((s, i) => {
            let prevX = (i === 0) ? 0 : segments[i-1].x;
            let prevY = (i === 0) ? parseFloat(document.getElementById('el_pmp').value) : segments[i-1].y;
            let L = Math.sqrt(Math.pow(s.x - prevX, 2) + Math.pow(s.y - prevY, 2)).toFixed(2);
            let mat = materialsData[s.matIdx];
            let coefVal = (method === "HW") ? `C=${mat.c}` : `ε=${mat.eps}`;
            
            return `<div class="card">
                <div class="seg-header">
                    <span class="badge-l">Panjang: ${L} m</span>
                    <span class="badge-c">${coefVal}</span>
                </div>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Posisi X (m)</label><input type="number" value="${s.x}" onchange="segments[${i}].x=parseFloat(this.value); renderSegmentsUI(); runSimulation();"></div>
                    <div style="flex:1"><label>Elevasi Y (m)</label><input type="number" value="${s.y}" onchange="segments[${i}].y=parseFloat(this.value); renderSegmentsUI(); runSimulation();"></div>
                </div>
                <label>Diameter (m)</label>
                <input type="number" value="${s.d}" step="0.01" onchange="segments[${i}].d=parseFloat(this.value); runSimulation();">
                <select onchange="segments[${i}].matIdx=this.selectedIndex; renderSegmentsUI(); runSimulation();">
                    ${materialsData.map((m, idx) => `<option value="${idx}" ${s.matIdx === idx ? 'selected' : ''}>${m.label}</option>`).join('')}
                </select></div>`;
        }).join('');
    }

    function addSegment() { segments.push({...segments[segments.length-1], x: segments[segments.length-1].x + 50}); renderSegmentsUI(); }

    function runSimulation() {
        const method = document.getElementById('calc_method').value;
        const totalK = renderFitting();
        const Q = parseFloat(document.getElementById('debit').value) || 0.0001;
        const hP = parseFloat(document.getElementById('head_pmp').value) || 0;
        const elD = parseFloat(document.getElementById('el_dasar').value);
        const tA = parseFloat(document.getElementById('t_air').value);
        const elPmp = parseFloat(document.getElementById('el_pmp').value);
        const g = 9.81; const nu = 1.004e-6; // viskositas air

        let waterSurface = elD + tA;
        let results = [];
        let velocities = [];

        results.push({ name: "Reservoir", info: "-", L: 0, v: 0, vH: 0, f: "-", hw: 0, hgl: waterSurface, res: 0, x1: -40, y1: elD, x2: 0, y2: waterSurface });
        let curHGL = waterSurface + hP;
        results.push({ name: "Pompa", info: "-", L: 0, v: 0, vH: 0, f: "-", hw: 0, hgl: curHGL, res: curHGL - elPmp, x1: 0, y1: elPmp, x2: 0, y2: elPmp });

        let prevX = 0, prevY = elPmp;
        segments.forEach((s, i) => {
            const L = Math.sqrt(Math.pow(s.x-prevX, 2) + Math.pow(s.y-prevY, 2));
            const v = Q / (0.25 * Math.PI * Math.pow(s.d, 2));
            const vH = (v**2)/(2 * g);
            const mat = materialsData[s.matIdx];
            let hw = 0, fVal = "-";

            if (method === "HW") {
                hw = (10.67 * L * Math.pow(Q, 1.852)) / (Math.pow(mat.c, 1.852) * Math.pow(s.d, 4.87));
            } else {
                let Re = (v * s.d) / nu;
                if (Re > 2300) {
                    fVal = 0.25 / Math.pow(Math.log10((mat.eps/(3.7*s.d)) + (5.74/Math.pow(Re, 0.9))), 2);
                } else {
                    fVal = 64 / Re;
                }
                hw = fVal * (L/s.d) * vH;
                fVal = fVal.toFixed(4);
            }

            const minor = (i === 0) ? (totalK * vH) : 0; 
            curHGL -= (hw + minor);
            velocities.push(v);
            results.push({ name: `Segmen ${i+1}`, info: (method==='HW'?mat.c:mat.eps), L, v, vH, f: fVal, hw, hgl:curHGL, res:curHGL-s.y, x1:prevX, y1:prevY, x2:s.x, y2:s.y });
            prevX=s.x; prevY=s.y;
        });

        document.getElementById('table-body').innerHTML = results.map((r,idx) => {
            const vOk = r.v >= 1.5 && r.v <= 2.5; const hOk = r.res >= 1.0;
            return `<tr class="${idx < 2 ? 'row-special' : ''}"><td>${r.name}</td><td>${r.info}</td><td>${r.L.toFixed(1)}</td>
                <td style="color:${idx<2?'inherit':(vOk?'var(--success)':'var(--danger)')}; font-weight:bold">${idx < 2 ? '-' : r.v.toFixed(2)}</td>
                <td>${r.f}</td><td>${r.hw.toFixed(3)}</td><td>${r.hgl.toFixed(2)}</td>
                <td style="font-weight:bold; color:${hOk?'var(--success)':'var(--danger)'}">${idx === 0 ? '-' : r.res.toFixed(2) + ' m'}</td></tr>`;
        }).join('');

        const vAllOk = velocities.every(v => v >= 1.5 && v <= 2.5);
        const hFinalOk = results[results.length-1].res >= 1.0;
        document.getElementById('status-kecepatan').style.background = vAllOk ? 'var(--success)' : 'var(--danger)';
        document.getElementById('status-kecepatan').innerText = `STATUS KECEPATAN: ${vAllOk?'MEMENUHI':'TIDAK MEMENUHI'}`;
        document.getElementById('status-head').style.background = hFinalOk ? 'var(--success)' : 'var(--danger)';
        document.getElementById('status-head').innerText = `STATUS HEAD SISA: ${hFinalOk?'MEMENUHI':'TIDAK MEMENUHI'}`;

        draw(results, elD, tA);
    }

    function draw(res, elD, tA) {
        const c = document.getElementById('pCanvas'); const ctx = c.getContext('2d');
        c.width = c.offsetWidth; c.height = c.offsetHeight;
        const allX = res.map(r => r.x1).concat(res.map(r => r.x2));
        const allY = res.map(r => r.hgl).concat(res.map(r => r.y2)).concat([elD]);
        const minX = Math.min(...allX); const maxX = Math.max(...allX);
        const minY = Math.min(...allY); const maxY = Math.max(...allY);
        const margin = 75;
        const scaleX = (c.width - margin * 2) / (maxX - minX || 100);
        const scaleY = (c.height - margin * 2) / (maxY - minY || 20);
        const gX = v => margin + (v - minX) * scaleX;
        const gY = v => c.height - margin - (v - minY) * scaleY;

        // LEGENDA
        ctx.font = "11px Arial"; ctx.textAlign = "left";
        ctx.fillStyle = "red"; ctx.fillRect(c.width-150, 20, 15, 2); ctx.fillStyle = "black"; ctx.fillText("HGL (Tekanan)", c.width-130, 25);
        ctx.fillStyle = "blue"; ctx.fillRect(c.width-150, 40, 15, 2); ctx.fillStyle = "black"; ctx.fillText("EGL (Total Energy)", c.width-130, 45);
        ctx.fillStyle = "#334155"; ctx.fillRect(c.width-150, 60, 15, 6); ctx.fillStyle = "black"; ctx.fillText("Pipa Jalur", c.width-130, 66);

        // RESERVOIR
        ctx.fillStyle = "rgba(14, 165, 233, 0.2)"; ctx.fillRect(gX(-40), gY(elD+tA), 40*scaleX, tA*scaleY);
        ctx.strokeStyle = "#0f172a"; ctx.lineWidth = 2; ctx.strokeRect(gX(-40), gY(elD+tA), 40*scaleX, tA*scaleY);
        ctx.fillStyle = "#0f172a"; ctx.font = "bold 13px Segoe UI"; ctx.textAlign = "center";
        ctx.fillText("RESERVOIR", gX(-20), gY(elD+tA) - 15);
        
        // HGL STARTING
        ctx.setLineDash([6,4]); ctx.strokeStyle="red"; ctx.beginPath();
        ctx.moveTo(gX(-40), gY(elD+tA)); ctx.lineTo(gX(0), gY(elD+tA)); 
        ctx.lineTo(gX(0), gY(res[1].hgl)); ctx.stroke();

        res.forEach((r, idx) => {
            if (idx >= 2) {
                ctx.lineWidth=7; ctx.strokeStyle = "#334155"; ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(gX(r.x1), gY(r.y1)); ctx.lineTo(gX(r.x2), gY(r.y2)); ctx.stroke();
                
                ctx.fillStyle = "#0f172a"; ctx.font = "bold 12px Segoe UI"; ctx.textAlign = "center";
                ctx.fillText(`SEGMEN ${idx-1}`, (gX(r.x1)+gX(r.x2))/2, (gY(r.y1)+gY(r.y2))/2 - 20);
                
                ctx.lineWidth=2; ctx.setLineDash([6,4]); ctx.strokeStyle="red"; 
                ctx.beginPath(); ctx.moveTo(gX(r.x1), gY(res[idx-1].hgl)); ctx.lineTo(gX(r.x2), gY(r.hgl).toFixed(2)); ctx.stroke();
                ctx.setLineDash([]); ctx.strokeStyle="blue"; 
                ctx.beginPath(); ctx.moveTo(gX(r.x1), gY(res[idx-1].hgl+r.vH)); ctx.lineTo(gX(r.x2), gY(r.hgl+r.vH)); ctx.stroke();
            }
        });

        // POMPA ICON & NOTATION
        ctx.beginPath(); ctx.fillStyle = "#0f172a"; ctx.arc(gX(0), gY(res[1].y1), 16, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.fillText("P", gX(0), gY(res[1].y1)+5);
        ctx.fillStyle = "#0f172a"; ctx.font = "bold 13px Segoe UI"; ctx.fillText("POMPA", gX(0), gY(res[1].y1) + 38);
    }

    window.onload = () => { renderFitting(); renderSegmentsUI(); runSimulation(); };
</script>

</body>
</html>