<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>PUMP STORAGE SIMULATOR - Seksi Perencanaan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
    <style>
        :root { --navy: #0a1931; --blue-main: #2563eb; --orange: #f39c12; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header Styling Sesuai Masukan Terakhir */
        .header { background: var(--navy); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--orange); }
        .header-title-box { display: flex; flex-direction: column; gap: 2px; }
        .header-title { font-weight: 800; font-size: 1.2rem; letter-spacing: 0.5px; text-transform: uppercase; }
        /* Teks Instansi di Bold */
        .header-subtitle { font-weight: 700; font-size: 0.8rem; color: var(--orange); }
        .header-right { display: flex; align-items: center; }
        /* Badge Kredit AsproXSudinJS */
        .credit-badge { background: rgba(243, 156, 18, 0.1); border: 1px solid var(--orange); color: var(--orange); padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; letter-spacing: 0.5px; }

        .wrapper { display: flex; flex: 1; padding: 12px; gap: 12px; overflow: hidden; }
        .sidebar { width: 340px; background: white; border-radius: 8px; padding: 15px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section-title { font-size: 0.75rem; font-weight: 800; color: var(--orange); margin: 12px 0 8px; text-transform: uppercase; border-left: 3px solid var(--orange); padding-left: 8px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .input-item label { display: block; font-size: 0.65rem; color: #475569; margin-bottom: 3px; font-weight: 700; text-transform: uppercase; }
        .input-item input { width: 100%; padding: 7px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; }
        .input-item input[readonly] { background: #f8fafc; color: var(--blue-main); font-weight: 800; border-color: #e2e8f0; }
        
        .mode-toggle { display: flex; background: #f1f5f9; padding: 3px; border-radius: 6px; margin-bottom: 10px; }
        .mode-btn { flex: 1; border: none; padding: 5px; font-size: 0.65rem; font-weight: 800; cursor: pointer; border-radius: 4px; color: #64748b; background: transparent; }
        .mode-btn.active { background: white; color: var(--blue-main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        textarea { width: 100%; height: 80px; font-family: monospace; font-size: 0.8rem; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; box-sizing: border-box; resize: none; }
        .btn-run { width: 100%; background: #10b981; color: white; border: none; padding: 14px; border-radius: 6px; font-weight: 800; cursor: pointer; margin-top: 15px; text-transform: uppercase; }

        .dashboard { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-card { background: white; border-radius: 8px; padding: 12px; border-top: 4px solid var(--blue-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card.p2 { border-top-color: var(--orange); }
        
        .card { background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chart-container { flex: 1.2; min-height: 0; }
        .table-container { flex: 0.8; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        thead th { background: #0f172a; color: white; padding: 10px; position: sticky; top: 0; z-index: 10; font-size: 0.65rem; }
        tbody td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }

        .status-pill { padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 0.65rem; display: inline-flex; align-items: center; gap: 6px; }
        .bg-running { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-idle { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title-box">
        <div class="header-title">PUMP STORAGE SIMULATION</div>
        <div class="header-subtitle">Seksi Perencanaan Sudin Sumber Daya Air Kota Jakarta Selatan</div>
    </div>
    <div class="header-right">
        <div class="credit-badge">AsproXSudinJS</div>
    </div>
</div>

<div class="wrapper">
    <aside class="sidebar">
        <div class="section-title">Konfigurasi Kolam Olakan</div>
        <div class="input-row">
            <div class="input-item"><label>Panjang (m)</label><input type="number" id="pjg" value="7.1"></div>
            <div class="input-item"><label>Lebar (m)</label><input type="number" id="lbr" value="3.1"></div>
        </div>
        <div class="input-row">
            <div class="input-item"><label>El. Dasar (m)</label><input type="number" id="ed" value="28.088" step="0.001"></div>
            <div class="input-item"><label>Tinggi Kolam (m)</label><input type="number" id="tk" value="5.0"></div>
        </div>

        <div class="section-title">Level Operasional</div>
        <div class="input-row">
            <div class="input-item"><label>Kedalaman LWL</label><input type="number" id="lwl" value="1.443" step="0.001"></div>
            <div class="input-item"><label>Elevasi LWL</label><input type="text" id="el_lwl" readonly></div>
        </div>
        <div class="input-row">
            <div class="input-item"><label>Kedalaman HWL 1</label><input type="number" id="hwl1" value="2.000" step="0.001"></div>
            <div class="input-item"><label>Elevasi HWL 1</label><input type="text" id="el_hwl1" readonly></div>
        </div>
        <div class="input-row">
            <div class="input-item"><label>Kedalaman HWL 2</label><input type="number" id="hwl2" value="4.500" step="0.001"></div>
            <div class="input-item"><label>Elevasi HWL 2</label><input type="text" id="el_hwl2" readonly></div>
        </div>

        <div class="section-title">Inflow & Kapasitas</div>
        <div class="input-item" style="margin-bottom: 10px;">
            <label>Kapasitas per Pompa (m続/s)</label>
            <input type="number" id="q_cap" value="0.25" step="0.01">
        </div>
        
        <div class="mode-toggle">
            <button id="btn-list" class="mode-btn active" onclick="setMode('list')">DAFTAR MANUAL</button>
            <button id="btn-const" class="mode-btn" onclick="setMode('const')">KONSTAN</button>
        </div>

        <div id="panel-list">
            <textarea id="inflowList">0.38
0.38
0.38
0.38
0.38</textarea>
        </div>
        <div id="panel-const" style="display:none;">
            <div class="input-row">
                <div class="input-item"><label>Debit (m続/s)</label><input type="number" id="q_const" value="0.38" step="0.01"></div>
                <div class="input-item"><label>Durasi (Menit)</label><input type="number" id="q_dur" value="10"></div>
            </div>
        </div>

        <button class="btn-run" onclick="runSim()">RUN SIMULATION</button>
    </aside>

    <main class="dashboard">
        <div class="stats-grid">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight: 800; font-size: 0.7rem;">POMPA 1 (P1)</span>
                    <span id="p1-status" style="font-size:0.6rem; font-weight:800; color:#10b981">READY</span>
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); text-align:center; margin-top:8px;">
                    <div><label style="font-size:0.5rem; color:#64748b">SIKLUS</label><p id="p1-c" style="margin:0; font-weight:800">0</p></div>
                    <div><label style="font-size:0.5rem; color:#64748b">DURASI</label><p id="p1-d" style="margin:0; font-weight:800">0 m</p></div>
                    <div><label style="font-size:0.5rem; color:#64748b">BEBAN</label><p id="p1-l" style="margin:0; font-weight:800">0%</p></div>
                </div>
            </div>
            <div class="stat-card p2">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight: 800; font-size: 0.7rem;">POMPA 2 (P2)</span>
                    <span id="p2-status" style="font-size:0.6rem; font-weight:800; color:#10b981">READY</span>
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); text-align:center; margin-top:8px;">
                    <div><label style="font-size:0.5rem; color:#64748b">SIKLUS</label><p id="p2-c" style="margin:0; font-weight:800">0</p></div>
                    <div><label style="font-size:0.5rem; color:#64748b">DURASI</label><p id="p2-d" style="margin:0; font-weight:800">0 m</p></div>
                    <div><label style="font-size:0.5rem; color:#64748b">BEBAN</label><p id="p2-l" style="margin:0; font-weight:800">0%</p></div>
                </div>
            </div>
        </div>

        <div class="card chart-container"><canvas id="pChart"></canvas></div>

        <div class="card table-container">
            <table id="sTable">
                <thead>
                    <tr><th>Menit</th><th>Inflow (m続/s)</th><th>TMA Sensor (m)</th><th>Duty</th><th>P1</th><th>P2</th><th>Q Out (m続/s)</th><th>EL. Akhir (m)</th><th>Status</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>
</div>

<script>
let chart;
let inputMode = 'list';

function setMode(m) {
    inputMode = m;
    document.getElementById('btn-list').classList.toggle('active', m==='list');
    document.getElementById('btn-const').classList.toggle('active', m==='const');
    document.getElementById('panel-list').style.display = m==='list'?'block':'none';
    document.getElementById('panel-const').style.display = m==='const'?'block':'none';
}

function updateStaticElevs() {
    const ed = parseFloat(document.getElementById('ed').value) || 0;
    const lwl = parseFloat(document.getElementById('lwl').value) || 0;
    const hw1 = parseFloat(document.getElementById('hwl1').value) || 0;
    const hw2 = parseFloat(document.getElementById('hwl2').value) || 0;
    document.getElementById('el_lwl').value = (ed + lwl).toFixed(3);
    document.getElementById('el_hwl1').value = (ed + hw1).toFixed(3);
    document.getElementById('el_hwl2').value = (ed + hw2).toFixed(3);
}

function runSim() {
    updateStaticElevs();
    const Area = parseFloat(document.getElementById('pjg').value) * parseFloat(document.getElementById('lbr').value);
    const ED = parseFloat(document.getElementById('ed').value);
    const TK = parseFloat(document.getElementById('tk').value);
    const LWL = parseFloat(document.getElementById('lwl').value); 
    const HWL1 = parseFloat(document.getElementById('hwl1').value); 
    const HWL2 = parseFloat(document.getElementById('hwl2').value); 
    const Q_CAP = parseFloat(document.getElementById('q_cap').value);

    let rawData = [];
    if (inputMode === 'list') {
        rawData = document.getElementById('inflowList').value.trim().split('\n').map(v => parseFloat(v.replace(',','.')) || 0);
    } else {
        const cVal = parseFloat(document.getElementById('q_const').value) || 0;
        const cDur = parseInt(document.getElementById('q_dur').value) || 1;
        rawData = Array(cDur).fill(cVal);
    }

    const tbody = document.querySelector('#sTable tbody');
    tbody.innerHTML = '';

    let storage = LWL * Area; 
    let tma_depth = LWL; 
    let s1 = "OFF", s2 = "OFF", pCode = "P1"; 

    tbody.innerHTML += `<tr><td>0</td><td>-</td><td>-</td><td>-</td><td>OFF</td><td>OFF</td><td>-</td><td style="font-weight:800; color:var(--blue-main)">${(LWL + ED).toFixed(3)}</td><td><span class="status-pill bg-idle"><span class="dot" style="background:#94a3b8"></span>START</span></td></tr>`;

    let p1C = 0, p1M = 0, p1Was = false, p2C = 0, p2M = 0, p2Was = false;
    let labels = [0], plotFinal = [(LWL + ED).toFixed(3)], plotSensor = [null];

    rawData.forEach((q_in, i) => {
        let m = i + 1;
        let in_vol_min = q_in * 60;
        let tma_sensor_val = (storage + in_vol_min) / Area; 
        let el_sensor = tma_sensor_val + ED;

        let s1_old = s1, s2_old = s2;
        if (pCode === "P1") {
            s1 = (tma_sensor_val >= HWL1) ? "ON" : (tma_depth <= LWL ? "OFF" : s1_old);
            s2 = (tma_sensor_val >= HWL2) ? "ON" : (tma_depth <= LWL ? "OFF" : s2_old);
        } else {
            s2 = (tma_sensor_val >= HWL1) ? "ON" : (tma_depth <= LWL ? "OFF" : s2_old);
            s1 = (tma_sensor_val >= HWL2) ? "ON" : (tma_depth <= LWL ? "OFF" : s1_old);
        }

        let q_out_total_s = (s1 === "ON" ? Q_CAP : 0) + (s2 === "ON" ? Q_CAP : 0);
        storage = Math.max(0, storage + in_vol_min - (q_out_total_s * 60));
        tma_depth = storage / Area; 
        let el_fin = tma_depth + ED;

        if (tma_depth <= LWL) { pCode = (pCode === "P1") ? "P2" : "P1"; }
        if (s1 === "ON") { p1M++; if (!p1Was) p1C++; }
        if (s2 === "ON") { p2M++; if (!p2Was) p2C++; }
        p1Was = (s1 === "ON"); p2Was = (s2 === "ON");

        tbody.innerHTML += `<tr><td>${m}</td><td>${q_in.toFixed(3)}</td><td>${el_sensor.toFixed(3)}</td><td style="color:blue;font-weight:bold">${pCode}</td><td style="font-weight:bold;color:${s1==='ON'?'#10b981':'#cbd5e1'}">${s1}</td><td style="font-weight:bold;color:${s2==='ON'?'#10b981':'#cbd5e1'}">${s2}</td><td>${q_out_total_s.toFixed(2)}</td><td style="font-weight:800">${el_fin.toFixed(3)}</td><td><span class="status-pill ${q_out_total_s > 0 ? 'bg-running' : 'bg-idle'}"><span class="dot" style="background:${q_out_total_s > 0 ? '#22c55e' : '#94a3b8'}"></span>${q_out_total_s > 0 ? 'RUNNING' : 'STANDBY'}</span></td></tr>`;
        
        labels.push(m);
        plotFinal.push(el_fin.toFixed(3));
        plotSensor.push(el_sensor.toFixed(3));
    });

    document.getElementById('p1-c').innerText = p1C;
    document.getElementById('p1-d').innerText = p1C > 0 ? (p1M/p1C).toFixed(1) + " m" : "0 m";
    document.getElementById('p1-l').innerText = ((p1M/rawData.length)*100).toFixed(0) + "%";
    document.getElementById('p2-c').innerText = p2C;
    document.getElementById('p2-d').innerText = p2C > 0 ? (p2M/p2C).toFixed(1) + " m" : "0 m";
    document.getElementById('p2-l').innerText = ((p2M/rawData.length)*100).toFixed(0) + "%";

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById('pChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'EL. TMA Akhir (m)', data: plotFinal, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.1, z: 5 },
                { label: 'TMA Sensor (Pemicu)', data: plotSensor, borderColor: 'rgba(125, 211, 252, 0.4)', borderDash: [5, 5], fill: false, tension: 0.1, z: 1 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                annotation: {
                    annotations: {
                        top: { type: 'line', yMin: ED+TK, yMax: ED+TK, borderColor: 'red', borderDash: [6,6], label: {display: true, content: 'Top Kolam', position: 'end', backgroundColor: 'red', color: '#fff', font: {size: 10, weight: 'bold'}}},
                        hw2: { type: 'line', yMin: ED+HWL2, yMax: ED+HWL2, borderColor: '#f39c12', label: {display: true, content: 'HWL 2', position: 'end', backgroundColor: '#f39c12', color: '#fff', font: {size: 10, weight: 'bold'}}},
                        hw1: { type: 'line', yMin: ED+HWL1, yMax: ED+HWL1, borderColor: '#10b981', label: {display: true, content: 'HWL 1', position: 'end', backgroundColor: '#10b981', color: '#fff', font: {size: 10, weight: 'bold'}}},
                        lwl: { type: 'line', yMin: ED+LWL, yMax: ED+LWL, borderColor: '#334155', label: {display: true, content: 'LWL', position: 'end', backgroundColor: '#334155', color: '#fff', font: {size: 10, weight: 'bold'}}}
                    }
                }
            }
        }
    });
}
window.onload = () => { updateStaticElevs(); runSim(); };
</script>
</body>
</html>